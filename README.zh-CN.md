# DeltaSync

一个极致轻量的基于CRDT的双向同步框架，支持文档型数据和附件的多设备同步。


## 特性

- **极致轻量化**：简单整合到任何数据库系统
- **自动版本跟踪**：每条数据自动带有版本号，确保同步一致性
- **冲突解决**：基于时间戳的自动冲突解决策略
- **文件附件同步**：支持数据关联文件的同步
- **自定义同步策略**：可根据应用需求定制同步行为
- **批处理性能**：批量处理数据变更提高性能
- **事件驱动架构**：易于集成到各种应用框架中
- **离线优先支持**：完全支持离线操作和自动恢复同步
- **TypeScript友好**：完整的类型定义提供良好的开发体验
- **端到端加密支持**：保护敏感数据安全


## Installation

```bash
npm install delta-sync
```



## 冲突解决 (Conflict Resolution)

DeltaSync 默认采用"最后修改胜出"的策略解决冲突。当多个设备对同一数据进行修改时，系统会根据时间戳和版本号决定以哪个版本为准。


## 实现原理
DeltaSync 通过 DataAdapter 接口实现数据库无关的同步机制，支持多种存储解决方案。


## 核心架构
适配器层 (Adapter Layer)

DataAdapter 接口：定义了一套通用的数据操作接口，包括读取、写入、删除等基本操作
专用适配器：为各种数据库系统提供具体实现，如 IndexedDB、SQLite、REST API 等
无缝转换：将各种数据库的特定 API 转换为统一的接口，屏蔽底层差异

同步协调层 (Sync Coordination)

SyncCoordinator：客户端协调器，负责跟踪本地数据变更
CloudCoordinator：服务端协调器，处理来自多个客户端的同步请求
自动变更记录：任何通过协调层的数据操作都会自动记录变更信息

数据版本跟踪 (Version Tracking)

版本号机制：每条数据都附带版本号(_ver)，基于时间戳自动更新
同步状态标记：通过 _sync_status 字段标记数据的同步状态（已同步/待同步）



### 同步流程 (Sync Process)

变更跟踪：本地操作通过协调层自动记录到 _sync_changes 表
变更推送：客户端将本地变更推送到服务器
冲突检测：服务器检测并解决可能的冲突
变更应用：服务器应用变更并记录到变更历史
变更拉取：客户端拉取服务器上的新变更
本地应用：客户端应用远程变更到本地数据库


### 离线支持 (Offline Support)

完全离线工作：应用可以在离线状态下正常工作，所有操作都在本地记录
自动同步恢复：网络连接恢复后，自动同步积累的变更
并发控制：防止多次同步请求同时执行导致的问题
该架构设计使 DeltaSync 能够在保持轻量级的同时，提供强大的跨数据库同步能力，适用于各种需要离线优先、实时数据同步的应用场景。



## 目录结构

```
|-- DeltaSync.code-workspace
|--- adapters
|   |-- indexeddb.ts
|   |-- rest.ts
|   `-- sqlite.ts
|-- core
|   |-- syncManager.ts    #调用协调层的同步管理器
|   |-- LocalCoordinator  #本地数据库的协调层
|   |-- CloudCoordinator  #服务数据库的协调层
|   `-- types.ts #类型定义
|-- docs
|-- lib   #工具函数
|-- examples
|   |-- react-native
|   `-- web
|-- index.ts
|-- package.json
`-- readme.md

```